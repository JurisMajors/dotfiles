#!/bin/bash

# Delay before starting
DELAY=2

# Duration and output file
tmp=$(mktemp)
if [ $# -gt 0 ]; then
    D="$1"
else
    D="10" 
fi

notify-send -u "low" -t 1000 "Select recording area"
# write the drawn rectangle to an array
IFS=" " read -ra RECTANGLE <<< "$(xrectsel -f "%x %y %w %h")" || exit -1
# delay for recording
for (( i=$DELAY; i>0; --i )) ; do
    notify-send -u "low" -t 1010 "Recording in ... $i"
    sleep 1
done
notify-send -t 500 "Recording for $D seconds!"

byzanz-record --verbose -c --delay=0 -x ${RECTANGLE[0]} -y ${RECTANGLE[1]} -w ${RECTANGLE[2]} -h ${RECTANGLE[3]} --duration=$D $tmp
notify-send -t 1010 "Recording finished!"
info="$(imgur-uploader $tmp)"
# parse the url from stupid imgur-uploader output
IFS=" " read -ra split_info <<< "$(echo $info | grep https)"
# save url to clipboard
echo "${split_info[-1]}" | xclip -selection clipboard
rm -f $tmp
